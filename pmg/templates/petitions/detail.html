{% extends "base.html" %}

{% block title %}{{ petition.title }} | PMG{% endblock %}

{% block head %}
<style>
.petition-status-1 {
  border-color: #f5f5f5 !important;
}

.petition-status-1 .panel-heading {
  background-color: #f5f5f5 !important;
  border-color: #f5f5f5 !important;
  color: #333 !important;
}

.petition-status-2 {
  border-color: #6495ed !important;
}

.petition-status-2 .panel-heading {
  background-color: #6495ed !important;
  border-color: #6495ed !important;
  color: white !important;
}

.petition-status-3 {
  border-color: #90ee90 !important;
}

.petition-status-3 .panel-heading {
  background-color: #90ee90 !important;
  border-color: #90ee90 !important;
  color: #333 !important;
}

.petition-status-4 {
  border-color: #337ab7 !important;
}

.petition-status-4 .panel-heading {
  background-color: #337ab7 !important;
  border-color: #337ab7 !important;
  color: white !important;
}

.petition-status-1 .panel-title,
.petition-status-2 .panel-title,
.petition-status-3 .panel-title,
.petition-status-4 .panel-title {
  font-weight: normal !important;
}

.label-info, .label-primary, .label-success {
  display: inline-block;
  margin-right: 0.5em;
}

.petition-event h5 a {
  color: #337ab7;
  text-decoration: none;
}

.petition-event h5 a:hover {
  color: #23527c;
  text-decoration: underline;
}
</style>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
  <li><a href="{{ url_for('petitions') }}">Petitions</a></li>
  <li class="active">{{ petition.title|truncate(50, True) }}</li>
</ol>
{% endblock %}

{% block page %}
<div class="petition-detail-page">
  <div class="row">
    <div class="col-sm-12">
      <header class="petition-header">
        <h1>
          <i class="fa fa-file-text-o"></i> {{ petition.title }}
        </h1>

        {% if petition.issue %}
        <p class="lead">{{ petition.issue }}</p>
        {% endif %}

        {% if petition.supporting_files %}
        <ul class="list-inline bill-versions">
          <li><h3>Supporting Documents:</h3></li>
          {% for petition_file in petition.supporting_files %}
          <li>
            <a href="{{ petition_file.file.url }}" target="_blank">
              <span class="label label-info" title="{{ petition_file.file.title }}">
                <i class="fa fa-file-text"></i> {{ petition_file.file.title }}
              </span>
            </a>
          </li>
          {% endfor %}
        </ul>
        {% endif %}

        {% if petition.report %}
        <ul class="list-inline bill-versions">
          <li><h3>Reports:</h3></li>
          <li>
            <a href="{{ petition.report.url }}" target="_blank">
              <span class="label label-success" title="{{ petition.report.title }}">
                <i class="fa fa-file-text"></i> {{ petition.report.title }}
              </span>
            </a>
          </li>
        </ul>
        {% endif %}
      </header>

      {% if petition.description %}
      <div class="petition-description-section">
        <p>{{ petition.description }}</p>
      </div>
      {% endif %}

      <div class="petition-status-container">
        <div class="c4sa-grey c4sa-progress"></div>
       
          <div class="c4sa-stage stage{{ petition.status.step }}">
        
          <div class="c4sa-green c4sa-progress stage"></div>
          <div class="c4sa-dot dot1"></div>
          <div class="c4sa-dot dot2"></div>
          <div class="c4sa-dot dot3"></div>
          <div class="c4sa-dot dot4"></div>
          <div class="process_dot"></div>
          <div class="c4sa-label label1">Tabled</div>
          <div class="c4sa-label label2">Under consideration by committee</div>
          <div class="c4sa-label label3">Under consideration by House</div>
          <div class="c4sa-label label4">Finalised</div>
        </div>
      </div>

    </div>  

    <!-- Petition Events -->
    <div class="bill-events">
      <h2>Petition History</h2>
      
      {% if all_events %}
        {% if petition.house and petition.house.name == 'National Assembly' %}
        <div class="panel panel-default bill-location NA">
          <div class="panel-heading">
            <h4 class="panel-title">National Assembly</h4>
          </div>
        {% elif petition.house and petition.house.name == 'National Council of Provinces' %}
        <div class="panel panel-default bill-location NCOP">
          <div class="panel-heading">
            <h4 class="panel-title">National Council of Provinces</h4>
          </div>
        {% else %}
        <div class="panel panel-default">
        {% endif %}
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-12">
                <div class="petition-history">
                  {% for event in all_events %}
                  <div class="petition-event">
                    <div class="media">
                      <div class="media-left">
                        {% if event.__class__.__name__ == 'CommitteeMeeting' or event.type == 'committee-meeting' %}
                        <img class="media-object stage-icon" src="/static/resources/images/petitions/meeting.png">
                        {% else %}
                        {% if event.type %}
                        <img class="media-object stage-icon" src="/static/resources/images/petitions/{{ event.type }}.png">
                        {% else %}
                        <img class="media-object stage-icon" src="/static/resources/images/petitions/other.png">
                        {% endif %}
                        {% endif %}
                      </div>
                      <div class="media-body">
                        <div class="row">
                          <div class="col-xs-4 col-md-2 text-muted">
                            {% if event.date %}
                              {{ event.date.strftime('%d %b %Y') }}
                            {% else %}
                              Date TBA
                            {% endif %}
                          </div>
                          <div class="col-xs-8 col-md-10">
                            {% if event.__class__.__name__ == 'CommitteeMeeting' or event.type == 'committee-meeting' %}
                            <h5><a href="/committee-meeting/{{ event.id }}">{{ event.title }}</a></h5>
                            <!-- {% if event.summary %}
                            <p class="text-muted"><small>{{ event.summary|truncate(200, True)|safe }}</small></p>
                            {% elif event.body %}
                            <p class="text-muted"><small>{{ event.body|truncate(200, True)|safe }}</small></p>
                            {% endif %} -->
                            {% elif event.__class__.__name__ == 'Hansard' or event.type == 'plenary' %}
                            <h5><a href="/hansard/{{ event.id }}">{{ event.title }}</a></h5>
                            {% if event.summary %}
                            <p class="text-muted"><small>{{ event.summary|truncate(200, True)|safe }}</small></p>
                            {% elif event.body %}
                            <p class="text-muted"><small>{{ event.body|truncate(200, True)|safe }}</small></p>
                            {% endif %}
                            {% else %}
                            {% if event.type == 'report' and event.committee_report %}
                            <h5><a href="/tabled-committee-report/{{ event.committee_report.id }}">{{ event.title }}</a></h5>
                            {% else %}
                            <h5>{{ event.title }}</h5>
                            {% endif %}
                            {% if event.description %}
                            <p class="text-muted"><small>{{ event.description }}</small></p>
                            {% endif %}
                            {% endif %}
                            
                            <div class="event-details">
                              {% if event.__class__.__name__ == 'CommitteeMeeting' or event.type == 'committee-meeting' %}
                              <span class="label label-info">Committee Meeting</span>
                              {% elif event.__class__.__name__ == 'Hansard' or event.type == 'plenary' %}
                              <span class="label label-info">Hansard</span>
                              {% else %}
                              {% if event.type %}
                              <span class="label label-info">{{ event.type|title|replace('-', ' ') }}</span>
                              {% endif %}
                              {% endif %}
                              
                              {% if event.committee %}
                              <span class="label label-success">{{ event.committee.name }}</span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% if not loop.last %}<hr>{% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <p class="text-muted">No events have been recorded for this petition yet.</p>
      {% endif %}
    </div>

    <!-- Document Viewer Section -->
    {% if petition.supporting_files %}
    {% set sorted_files = petition.supporting_files|sort(attribute='featured', reverse=true) %}
    <div class="petition-document-content">
      <h2>Documents</h2>

      <ul class="nav nav-tabs">
        {% for petition_file in sorted_files %}
        <li role="presentation" class="{% if loop.first %}active{% endif %}">
          <a href="#petition-document-{{ loop.index }}" data-toggle="tab" role="tab">
            <strong>{{ petition_file.file.title }}</strong>
          </a>
        </li>
        {% endfor %}
      </ul>

      <div class="tab-content">
        {% for petition_file in sorted_files %}
        <div role="tabpanel" class="tab-pane {% if loop.first %}active{% endif %}" id="petition-document-{{ loop.index }}">
          <div class="clearfix">
            <a href="{{ petition_file.file.url }}" target="_blank" class="btn btn-default pull-right">
              <i class="fa fa-file-text"></i> Download{% if petition_file.file.file_bytes %} ({{ petition_file.file.file_bytes | filesizeformat }}){% endif %}
            </a>
            <h4>{{ petition_file.file.title }}</h4>
          </div>

          {% if petition_file.file.file_mime == "application/pdf" %}
          <div class="petition-document-wrapper" data-url="{{ petition_file.file.url }}">
            <button class="btn btn-primary load-pdf">Show PDF{% if petition_file.file.file_bytes %} ({{ petition_file.file.file_bytes | filesizeformat }}){% endif %}</button>
          </div>
          {% else %}
          <div class="text-center" style="padding: 40px;">
            <p class="lead">Download doc</p>
            <a href="{{ petition_file.file.url }}" target="_blank" class="btn btn-primary btn-lg">
              <i class="fa fa-download"></i> Download Document{% if petition_file.file.file_bytes %} ({{ petition_file.file.file_bytes | filesizeformat }}){% endif %}
            </a>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block javascript %}
{{ super() }}
{% if petition.supporting_files %}
<script type="text/javascript" src="/static/resources/javascript/vendor/pdfjs/pdf.js"></script>
<script>PDFJS.workerSrc = '/static/resources/javascript/vendor/pdfjs/pdf.worker.js';</script>
<script>
  $(function() {
    function showPetitionPdf(button) {
      var tabPane = $(button).closest('.tab-pane'),
          wrapper = tabPane.find('.petition-document-wrapper')[0],
          url = wrapper.getAttribute('data-url');

      if (wrapper.getAttribute('data-loaded')) return;

      $(wrapper).empty();
      $(wrapper).append('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading PDF...</div>');

      PDFJS.getDocument(url + '?direct=1').then(function(pdf) {
        wrapper.setAttribute('data-loaded', true);
        $(wrapper).empty();

        function renderPage(page) {
          renderPetitionPdfPage(pdf, page, wrapper);
        }

        for (var i = 1; i <= pdf.numPages; i++) {
          pdf.getPage(i).then(renderPage);
        }

      }, function (reason) {
        
        PDFJS.getDocument(url).then(function(pdf) {
          wrapper.setAttribute('data-loaded', true);
          $(wrapper).empty();

          function renderPage(page) {
            renderPetitionPdfPage(pdf, page, wrapper);
          }

          for (var i = 1; i <= pdf.numPages; i++) {
            pdf.getPage(i).then(renderPage);
          }

        }, function (reason2) {
          $(wrapper).empty();
          $(wrapper).append('<div class="alert alert-danger">Failed to load PDF. <br><small>Error: ' + (reason2.message || 'Unknown error') + '</small></div>');
        });
      });
    }

    function renderPetitionPdfPage(pdf, pdfPage, wrapper) {
      var scale, viewport, canvas;

      if (wrapper.clientWidth > 800) {
        scale = 1.25;
      } else {
        scale = (wrapper.clientWidth - 40) / pdfPage.getViewport(1).width;
      }

      viewport = pdfPage.getViewport(scale);
      canvas = document.createElement('canvas');
      wrapper.appendChild(canvas);

      var context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      pdfPage.render({
        canvasContext: context,
        viewport: viewport
      });
    }

    $('.petition-document-content .load-pdf').on('click', function(e) {
      e.preventDefault();
      showPetitionPdf(this);
    });

    // Handle tab switching to ensure proper content display
    $('.petition-document-content a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      // When a new tab is shown, make sure its content is visible
      var target = $(e.target).attr("href");
      $(target).addClass('active').siblings().removeClass('active');
      
      // Also update the nav tabs
      $(e.target).parent().addClass('active').siblings().removeClass('active');
    });
  });
</script>
{% endif %}
{% endblock %}